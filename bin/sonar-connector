#!/usr/bin/env ruby

require File.join(File.dirname(__FILE__), '..', 'lib', 'sonar_connector')
require 'optparse'

config_filename = File.expand_path File.join(Dir.pwd, "config", "config.json")

ARGV.options do |opts|
  script_name = File.basename($0)

  opts.banner = "Usage: #{script_name} OPTION"
  opts.separator "Specific options:"
  
  opts.on("--start", "Start the connector") {
    puts "Bootstrapping the connector framework from config file #{config_filename}. Check logs for details."
    Sonar::Connector::Controller.new(config_filename).start
    exit
  }
  opts.on("--check", "Validate the connector config") {
    puts "Checking config in #{config_filename}:"
    Sonar::Connector::Controller.new(config_filename)
    puts "...clean."
    exit
  } 
  opts.on("-i", "--install=PATH", String, "Install the connector working dir and default config to the file system") {|p|
    path = File.expand_path p
    
    if File.directory?(path)
      puts "Error: Directory '#{path}' already exists, aborting."
      exit(1)
    end
    
    %W{config log var}.each {|dir| FileUtils.mkdir_p File.join(path, dir)}
    FileUtils.cp File.join(Sonar::Connector::ROOT, "config", "config.example.json"), File.join(path, 'config', 'config.json')
    puts "Success: Set up working directory '#{path}' and associated subdirs."
    exit
  }
  opts.on("--console", "Run IRB console in connector framework environment") {
    lib_path = File.expand_path File.join(File.dirname(__FILE__), '..', 'lib')
    Kernel.system "irb -rubygems -I #{lib_path} -r sonar_connector.rb"
    exit
  }
  opts.on_tail("-v", "--version", "Show version") {
    version_file = File.join File.expand_path(File.dirname(__FILE__)), "..", "VERSION"
    puts "SONAR Connector Framework #{File.read(version_file)}"
    exit
  }
  opts.on_tail("-h", "--help", "Show this message") {}
  opts.parse!
end

# default action 
puts ARGV.options